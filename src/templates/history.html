{% extends "base.html" %}

{% block title %}Historique - ENSAM Cloud Platform{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="glass-card border-b border-dark-border px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-neon-blue to-neon-purple flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold">Cloud Console</span>
                </div>
                
                <div class="hidden md:flex items-center gap-2 ml-8">
                    <a href="/app" class="px-4 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                        Éditeur
                    </a>
                    <a href="/history" class="px-4 py-2 rounded-lg bg-neon-blue/20 text-neon-blue font-medium">
                        Historique
                    </a>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <span id="user-name" class="text-sm text-gray-400"></span>
                <button onclick="logout()" class="p-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="flex-1 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Stats Cards -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Total Jobs</p>
                        <p id="stat-total" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Réussis</p>
                        <p id="stat-success" class="text-2xl font-bold text-green-400">-</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Échoués</p>
                        <p id="stat-failed" class="text-2xl font-bold text-red-400">-</p>
                    </div>
                </div>
            </div>
            
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-neon-blue/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-neon-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Jobs GPU</p>
                        <p id="stat-gpu" class="text-2xl font-bold text-neon-blue">-</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="glass-card rounded-xl p-6 mt-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-400">Statut:</label>
                    <select id="filter-status" onchange="loadJobs()" class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm focus:border-neon-blue outline-none">
                        <option value="">Tous</option>
                        <option value="success">Réussi</option>
                        <option value="failed">Échoué</option>
                        <option value="running">En cours</option>
                        <option value="pending">En attente</option>
                        <option value="cancelled">Annulé</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-400">Par page:</label>
                    <select id="filter-perpage" onchange="loadJobs()" class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm focus:border-neon-blue outline-none">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                
                <button onclick="loadJobs()" class="ml-auto px-4 py-2 rounded-lg border border-dark-border hover:border-neon-blue text-sm flex items-center gap-2 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Actualiser
                </button>
            </div>
        </div>
        
        <!-- Jobs Table -->
        <div class="glass-card rounded-xl p-6 mt-6">
            <h2 class="text-lg font-semibold mb-4">Historique des Jobs</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 text-sm border-b border-dark-border">
                            <th class="pb-3 font-medium">ID</th>
                            <th class="pb-3 font-medium">Script</th>
                            <th class="pb-3 font-medium">Statut</th>
                            <th class="pb-3 font-medium">Mode</th>
                            <th class="pb-3 font-medium">Profil</th>
                            <th class="pb-3 font-medium">Durée</th>
                            <th class="pb-3 font-medium">Soumis le</th>
                            <th class="pb-3 font-medium">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table" class="text-sm">
                        <tr>
                            <td colspan="8" class="py-8 text-center text-gray-500">Chargement...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between mt-6 pt-4 border-t border-dark-border">
                <p id="pagination-info" class="text-sm text-gray-400">-</p>
                <div class="flex items-center gap-2">
                    <button id="btn-prev" onclick="prevPage()" disabled class="px-3 py-1.5 rounded-lg border border-dark-border disabled:opacity-50 disabled:cursor-not-allowed hover:border-neon-blue transition-colors">
                        ← Précédent
                    </button>
                    <button id="btn-next" onclick="nextPage()" disabled class="px-3 py-1.5 rounded-lg border border-dark-border disabled:opacity-50 disabled:cursor-not-allowed hover:border-neon-blue transition-colors">
                        Suivant →
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Job Detail Modal -->
    <div id="job-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-dark-border">
                <h3 id="modal-title" class="text-xl font-semibold">Détails du Job</h3>
                <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <!-- Job Info -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-dark-bg rounded-lg p-3">
                        <p class="text-gray-400 text-xs mb-1">Statut</p>
                        <p id="modal-status" class="font-semibold">-</p>
                    </div>
                    <div class="bg-dark-bg rounded-lg p-3">
                        <p class="text-gray-400 text-xs mb-1">Mode</p>
                        <p id="modal-mode" class="font-semibold">-</p>
                    </div>
                    <div class="bg-dark-bg rounded-lg p-3">
                        <p class="text-gray-400 text-xs mb-1">Durée</p>
                        <p id="modal-duration" class="font-semibold">-</p>
                    </div>
                    <div class="bg-dark-bg rounded-lg p-3">
                        <p class="text-gray-400 text-xs mb-1">Code sortie</p>
                        <p id="modal-exit" class="font-semibold">-</p>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchModalTab('logs')" id="modal-tab-logs" class="modal-tab px-4 py-2 rounded-lg bg-neon-blue/20 text-neon-blue text-sm font-medium">
                        Logs
                    </button>
                    <button onclick="switchModalTab('code')" id="modal-tab-code" class="modal-tab px-4 py-2 rounded-lg text-gray-400 text-sm hover:text-white transition-colors">
                        Code
                    </button>
                    <button onclick="switchModalTab('metrics')" id="modal-tab-metrics" class="modal-tab px-4 py-2 rounded-lg text-gray-400 text-sm hover:text-white transition-colors">
                        Métriques
                    </button>
                </div>
                
                <!-- Logs Panel -->
                <div id="modal-panel-logs" class="bg-dark-bg rounded-lg p-4 font-mono text-sm max-h-80 overflow-auto">
                    <p class="text-gray-500">Chargement...</p>
                </div>
                
                <!-- Code Panel -->
                <div id="modal-panel-code" class="hidden bg-dark-bg rounded-lg p-4 font-mono text-sm max-h-80 overflow-auto">
                    <pre id="modal-code" class="text-gray-300 whitespace-pre-wrap"></pre>
                </div>
                
                <!-- Metrics Panel -->
                <div id="modal-panel-metrics" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="bg-dark-bg rounded-lg p-4">
                            <p class="text-gray-400 text-xs mb-1">CPU</p>
                            <p id="modal-cpu" class="text-lg font-semibold">-</p>
                        </div>
                        <div class="bg-dark-bg rounded-lg p-4">
                            <p class="text-gray-400 text-xs mb-1">RAM Peak</p>
                            <p id="modal-ram" class="text-lg font-semibold">-</p>
                        </div>
                        <div class="bg-dark-bg rounded-lg p-4">
                            <p class="text-gray-400 text-xs mb-1">GPU</p>
                            <p id="modal-gpu" class="text-lg font-semibold">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check authentication
    if (!TokenManager.isAuthenticated()) {
        window.location.href = '/login';
    }
    
    // Display user name
    const user = TokenManager.getUser();
    if (user) {
        document.getElementById('user-name').textContent = user.full_name || user.email;
    }
    
    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    
    // Load jobs
    async function loadJobs() {
        const status = document.getElementById('filter-status').value;
        const perPage = document.getElementById('filter-perpage').value;
        
        let url = `/api/jobs/history?page=${currentPage}&per_page=${perPage}`;
        if (status) url += `&status_filter=${status}`;
        
        try {
            const response = await API.get(url);
            const data = await response.json();
            
            const tbody = document.getElementById('jobs-table');
            
            if (!data.jobs || data.jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-500">Aucun job trouvé</td></tr>';
                updatePagination(0, 1, 1);
                return;
            }
            
            tbody.innerHTML = data.jobs.map(job => `
                <tr class="border-b border-dark-border/50 hover:bg-white/5 transition-colors">
                    <td class="py-4 font-mono text-neon-blue">#${job.id}</td>
                    <td class="py-4">${job.script_name}</td>
                    <td class="py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium badge-${job.status}">
                            ${job.status}
                        </span>
                    </td>
                    <td class="py-4">
                        <span class="uppercase text-xs ${job.execution_mode === 'gpu' ? 'text-neon-purple' : 'text-gray-400'}">
                            ${job.execution_mode}
                        </span>
                    </td>
                    <td class="py-4 text-gray-400 text-xs uppercase">${job.resource_profile}</td>
                    <td class="py-4">${job.duration_seconds ? job.duration_seconds.toFixed(2) + 's' : '-'}</td>
                    <td class="py-4 text-gray-400">${new Date(job.created_at).toLocaleString('fr-FR')}</td>
                    <td class="py-4">
                        <button onclick="viewJobDetails(${job.id})" class="text-neon-blue hover:underline text-sm">
                            Voir
                        </button>
                        ${['pending', 'queued', 'running'].includes(job.status) ? `
                            <button onclick="cancelJob(${job.id})" class="text-red-400 hover:underline text-sm ml-3">
                                Annuler
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
            
            totalPages = data.pages;
            updatePagination(data.total, currentPage, totalPages);
            
        } catch (error) {
            console.error('Failed to load jobs:', error);
            showToast('Erreur lors du chargement', 'error');
        }
    }
    
    function updatePagination(total, page, pages) {
        document.getElementById('pagination-info').textContent = `${total} job(s) - Page ${page}/${pages}`;
        document.getElementById('btn-prev').disabled = page <= 1;
        document.getElementById('btn-next').disabled = page >= pages;
    }
    
    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadJobs();
        }
    }
    
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadJobs();
        }
    }
    
    // Load stats
    async function loadStats() {
        try {
            const response = await API.get('/api/metrics/user');
            const data = await response.json();
            
            document.getElementById('stat-total').textContent = data.total_jobs || 0;
            document.getElementById('stat-success').textContent = data.successful_jobs || 0;
            document.getElementById('stat-failed').textContent = data.failed_jobs || 0;
            
            // Get GPU count from system metrics
            const sysResponse = await API.get('/api/metrics/system');
            const sysData = await sysResponse.json();
            document.getElementById('stat-gpu').textContent = sysData.gpu_jobs || 0;
            
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }
    
    // View job details
    async function viewJobDetails(jobId) {
        try {
            const response = await API.get(`/api/jobs/${jobId}`);
            const job = await response.json();
            
            document.getElementById('modal-title').textContent = `Job #${job.id} - ${job.script_name}`;
            document.getElementById('modal-status').innerHTML = `<span class="badge-${job.status} px-2 py-0.5 rounded">${job.status}</span>`;
            document.getElementById('modal-mode').textContent = job.execution_mode.toUpperCase();
            document.getElementById('modal-duration').textContent = job.duration_seconds ? `${job.duration_seconds.toFixed(2)}s` : '-';
            document.getElementById('modal-exit').textContent = job.exit_code !== null ? job.exit_code : '-';
            
            // Logs
            const logsPanel = document.getElementById('modal-panel-logs');
            if (job.output) {
                logsPanel.innerHTML = job.output.split('\n').map(line => 
                    `<p class="text-gray-300">${escapeHtml(line)}</p>`
                ).join('');
            } else if (job.error_message) {
                logsPanel.innerHTML = `<p class="text-red-400">${escapeHtml(job.error_message)}</p>`;
            } else {
                logsPanel.innerHTML = '<p class="text-gray-500">Pas de logs disponibles</p>';
            }
            
            // Code
            document.getElementById('modal-code').textContent = job.script_content || 'Code non disponible';
            
            // Metrics (placeholder)
            document.getElementById('modal-cpu').textContent = job.duration_seconds ? `${job.duration_seconds.toFixed(1)}s` : '-';
            document.getElementById('modal-ram').textContent = '-';
            document.getElementById('modal-gpu').textContent = job.gpu_used ? 'Utilisé' : 'Non';
            
            // Show modal
            document.getElementById('job-modal').classList.remove('hidden');
            switchModalTab('logs');
            
        } catch (error) {
            showToast('Erreur lors du chargement', 'error');
        }
    }
    
    function closeModal() {
        document.getElementById('job-modal').classList.add('hidden');
    }
    
    function switchModalTab(tab) {
        document.querySelectorAll('.modal-tab').forEach(btn => {
            btn.classList.remove('bg-neon-blue/20', 'text-neon-blue');
            btn.classList.add('text-gray-400');
        });
        document.getElementById(`modal-tab-${tab}`).classList.add('bg-neon-blue/20', 'text-neon-blue');
        document.getElementById(`modal-tab-${tab}`).classList.remove('text-gray-400');
        
        ['logs', 'code', 'metrics'].forEach(t => {
            document.getElementById(`modal-panel-${t}`).classList.toggle('hidden', t !== tab);
        });
    }
    
    // Cancel job
    async function cancelJob(jobId) {
        if (!confirm('Voulez-vous vraiment annuler ce job ?')) return;
        
        try {
            const response = await API.post(`/api/jobs/${jobId}/cancel`, {});
            const data = await response.json();
            
            if (data.success) {
                showToast('Job annulé', 'success');
                loadJobs();
                loadStats();
            } else {
                showToast(data.message || 'Erreur', 'error');
            }
        } catch (error) {
            showToast('Erreur lors de l\'annulation', 'error');
        }
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Close modal on escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
    
    // Close modal on backdrop click
    document.getElementById('job-modal').addEventListener('click', (e) => {
        if (e.target.id === 'job-modal') closeModal();
    });
    
    // Initial load
    loadJobs();
    loadStats();
</script>
{% endblock %}








